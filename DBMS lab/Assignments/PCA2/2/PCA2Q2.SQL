-- CREATE TABLE PERSON
CREATE TABLE PERSON (
    DRIVER_ID NUMBER PRIMARY KEY,
    NAME VARCHAR2(100),
    ADDRESS VARCHAR2(100)
);

-- INSERT SAMPLE DATA INTO PERSON
INSERT ALL 
INTO PERSON VALUES (1, 'John Doe', '123 Main St, Mumbai')
INTO PERSON VALUES (2, 'Jane Smith', '456 Elm St, Kolkata')
INTO PERSON VALUES (3, 'Alice Johnson', '789 Oak St, Delhi')
INTO PERSON VALUES (4, 'David Brown', '321 Pine St, Pune')
INTO PERSON VALUES (5, 'Emily White', '567 Cedar St, Mumbai')
SELECT * FROM DUAL;

-- CREATE TABLE CAR
CREATE TABLE CAR (
    REGISTRATION_NUMBER VARCHAR2(20) PRIMARY KEY,
    MODEL VARCHAR2(100),
    YEAR NUMBER
);

-- INSERT SAMPLE DATA INTO CAR
INSERT ALL 
INTO CAR VALUES ('ABC123', 'Toyota', 2005)
INTO CAR VALUES ('DEF456', 'Honda', 2001)
INTO CAR VALUES ('GHI789', 'Toyota', 2005)
INTO CAR VALUES ('JKL012', 'Ford', 2003)
INTO CAR VALUES ('MNO345', 'Toyota', 2002)
SELECT * FROM DUAL;

-- CREATE TABLE ACCIDENT
CREATE TABLE ACCIDENT (
    REPORT_NO NUMBER PRIMARY KEY,
    ADATE DATE,
    LOCATION VARCHAR2(100)
);

-- INSERT SAMPLE DATA INTO ACCIDENT
INSERT ALL 
INTO ACCIDENT VALUES (101, TO_DATE('2005-06-15', 'YYYY-MM-DD'), 'Mumbai')
INTO ACCIDENT VALUES (102, TO_DATE('2001-06-15', 'YYYY-MM-DD'), 'Kolkata')
INTO ACCIDENT VALUES (103, TO_DATE('2005-07-20', 'YYYY-MM-DD'), 'Delhi')
INTO ACCIDENT VALUES (104, TO_DATE('2005-08-10', 'YYYY-MM-DD'), 'Pune')
INTO ACCIDENT VALUES (105, TO_DATE('2005-09-05', 'YYYY-MM-DD'), 'Mumbai')
SELECT * FROM DUAL;

-- CREATE TABLE OWNS
CREATE TABLE OWNS (
    DRIVER_ID NUMBER,
    REGISTRATION_NUMBER VARCHAR2(20),
    CONSTRAINT OFK1 FOREIGN KEY (DRIVER_ID) REFERENCES PERSON(DRIVER_ID),
    CONSTRAINT OFK2 FOREIGN KEY (REGISTRATION_NUMBER) REFERENCES CAR(REGISTRATION_NUMBER)
);

-- INSERT SAMPLE DATA INTO OWNS
INSERT ALL 
INTO OWNS VALUES (1, 'ABC123')
INTO OWNS VALUES (2, 'DEF456')
INTO OWNS VALUES (3, 'GHI789')
INTO OWNS VALUES (4, 'JKL012')
INTO OWNS VALUES (5, 'MNO345')
SELECT * FROM DUAL;

-- CREATE TABLE PARTICIPATED_IN
CREATE TABLE PARTICIPATED_IN (
    DRIVER_ID NUMBER,
    REGISTRATION_NUMBER VARCHAR2(20),
    REPORT_NO NUMBER,
    DAMAGE_AMOUNT NUMBER(10, 2),
    CONSTRAINT PIFK1 FOREIGN KEY (DRIVER_ID) REFERENCES PERSON(DRIVER_ID),
    CONSTRAINT PIFK2 FOREIGN KEY (REGISTRATION_NUMBER) REFERENCES CAR(REGISTRATION_NUMBER),
    CONSTRAINT PIFK3 FOREIGN KEY (REPORT_NO) REFERENCES ACCIDENT(REPORT_NO)
);

-- INSERT SAMPLE DATA INTO PARTICIPATED_IN
INSERT ALL 
INTO PARTICIPATED_IN VALUES (1, 'ABC123', 101, 20000.00)
INTO PARTICIPATED_IN VALUES (2, 'DEF456', 102, 30000.00)
INTO PARTICIPATED_IN VALUES (3, 'GHI789', 101, 50000.00)
INTO PARTICIPATED_IN VALUES (4, 'JKL012', 103, 40000.00)
INTO PARTICIPATED_IN VALUES (5, 'MNO345', 105, 25000.00)
SELECT * FROM DUAL;

-- QUERY 1
-- Find the number of people who owned new cars that were involved in accidents in the year 2005 at -- "Mumbai"

SELECT COUNT(DISTINCT P.DRIVER_ID)
FROM PERSON P
JOIN OWNS O ON P.DRIVER_ID = O.DRIVER_ID
JOIN CAR C ON O.REGISTRATION_NUMBER = C.REGISTRATION_NUMBER
JOIN PARTICIPATED_IN PI ON o.DRIVER_ID = PI.DRIVER_ID AND o.REGISTRATION_NUMBER = PI.REGISTRATION_NUMBER
JOIN ACCIDENT A ON PI.REPORT_NO = A.REPORT_NO
WHERE C.YEAR >= 2005
    AND A.LOCATION = 'Mumbai'
    AND EXTRACT(YEAR FROM A.ADATE) = 2005;

-- QUERY 2
-- For every accident that took place in "Kolkata" and on "15-06-2001", retrieve the driver details -- and the amount of damage

SELECT P.NAME AS DRIVER_NAME, PI.DAMAGE_AMOUNT
FROM PERSON P
JOIN PARTICIPATED_IN PI ON P.DRIVER_ID = PI.DRIVER_ID
JOIN ACCIDENT A ON PI.REPORT_NO = A.REPORT_NO
WHERE A.LOCATION = 'Kolkata'
    AND A.ADATE = TO_DATE('2001-06-15', 'YYYY-MM-DD');

-- QUERY 3
-- For the "Toyota" belonging to "Huffman", find the accidents that took place in "Delhi" but not in -- "Pune"

SELECT A.REPORT_NO, A.ADATE, A.LOCATION
FROM ACCIDENT A
JOIN PARTICIPATED_IN PI ON A.REPORT_NO = PI.REPORT_NO
JOIN CAR C ON PI.REGISTRATION_NUMBER = C.REGISTRATION_NUMBER
JOIN OWNS O ON C.REGISTRATION_NUMBER = O.REGISTRATION_NUMBER
JOIN PERSON P ON O.DRIVER_ID = P.DRIVER_ID
WHERE C.MODEL = 'Toyota'
    AND P.NAME = 'Huffman'
    AND A.LOCATION = 'Delhi'
    AND A.LOCATION NOT IN ('Pune');

-- QUERY 4
-- For every person who owns more than 2 cars, find the details for those cars which incurred damage -- of Rs.50000 and above for accidents that took place in 2005

SELECT P.NAME AS DRIVER_NAME, C.MODEL, A.LOCATION, PI.DAMAGE_AMOUNT
FROM PERSON P
JOIN OWNS O ON P.DRIVER_ID = O.DRIVER_ID
JOIN CAR C ON O.REGISTRATION_NUMBER = C.REGISTRATION_NUMBER
JOIN PARTICIPATED_IN PI ON O.DRIVER_ID = PI.DRIVER_ID AND O.REGISTRATION_NUMBER = PI.REGISTRATION_NUMBER
JOIN ACCIDENT A ON PI.REPORT_NO = A.REPORT_NO
WHERE (SELECT COUNT(REGISTRATION_NUMBER) FROM OWNS WHERE DRIVER_ID = P.DRIVER_ID) > 2
    AND PI.DAMAGE_AMOUNT >= 50000.00
    AND EXTRACT(YEAR FROM A.ADATE) = 2005;
